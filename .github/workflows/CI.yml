# https://cpp-linter.github.io/cpp-linter-action/

name: CI

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

on:
    push:
        branches-ignore:
            - '*Test*'
    pull_request:
        branches-ignore:
            - '*Test*'

jobs:
    Test:
        if: false
        runs-on: ubuntu-latest

        defaults:
            run:
                shell: bash

        steps:
            -   name: Cache git submodules
                uses: actions/cache@v4
                with:
                    key: "${{ runner.os }}-git-${{ hashFiles('.git/modules/*/HEAD') }}" # Cache will be dismissed if any submodule change
                    path: ".git"
                    restore-keys: "${{ runner.os }}-git-"

            -   name: "Checkout repository"
                uses: actions/checkout@v4
                with:
                    submodules: 'recursive'
                    token: ${{ secrets.SubmoduleToken }}

            -   name: Configure CMake
                run: sudo apt install gcovr && cmake -S $GITHUB_WORKSPACE -B ${{runner.workspace}}/build

            -   name: Build
                working-directory: ${{runner.workspace}}/build
                run: cmake --build .

            -   name: Test
                working-directory: ${{runner.workspace}}/build
                run: ./Tests/SettingsStorage_GoogleTestsExe

    Linter:
        runs-on: ubuntu-latest
        needs: Test

        defaults:
            run:
                shell: bash

        permissions:
            contents: write
            pull-requests: write

        steps:
            -   name: Cache git submodules
                uses: actions/cache@v4
                with:
                    key: "${{ runner.os }}-git-${{ hashFiles('.git/modules/*/HEAD') }}" # Cache will be dismissed if any submodule change
                    path: ".git"
                    restore-keys: "${{ runner.os }}-git-"

            -   name: "Checkout repository"
                uses: actions/checkout@v4
                with:
                    submodules: 'recursive'
                    token: ${{ secrets.SubmoduleToken }}

            -   name: Configure CMake
                run: sudo apt install gcovr && cmake -S $GITHUB_WORKSPACE -B ${{runner.workspace}}/build

            -   name: Linter
                uses: cpp-linter/cpp-linter-action@v2
                id: linter
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                with:
                    version: 19
                    ignore: 'Source/deps/'
                    style: 'file'  # Use .clang-format config file
                    tidy-checks: '' # Use .clang-tidy config file
                    database: '${{runner.workspace}}/build'
                    step-summary: true
                    tidy-review: true
                    format-review: true
                    lines-changed-only: false # Only Check the lines that have changed
                    files-changed-only: false # Only check the files that have changed
                    # only 'update' a single comment in a pull request thread.
                    thread-comments: ${{ github.event_name == 'pull_request' && 'update' }}

            -   name: Clang Tidy Fail Check
                if: steps.linter.outputs.clang-tidy-checks-failed > 0
                run: exit 0 # To enable or disable this check as an error, run exit 1 / exit 0.

            -   name: Clang Format Fail Check
                if: steps.linter.outputs.clang-format-checks-failed > 0
                run: exit 0 # To enable or disable this check as an error, run exit 1 / exit 0.
    Sonar:
        runs-on: ubuntu-latest
        # needs: Test
        env:
            BUILD_WRAPPER_OUT_DIR: build_wrapper_output_directory # Directory where build-wrapper output will be placed
        steps:
            -   name: Cache git submodules
                uses: actions/cache@v4
                with:
                    key: "${{ runner.os }}-git-${{ hashFiles('.git/modules/*/HEAD') }}" # Cache will be dismissed if any submodule change
                    path: ".git"
                    restore-keys: "${{ runner.os }}-git-"

            -   name: "Checkout repository"
                uses: actions/checkout@v4
                with:
                    submodules: 'recursive'
                    token: ${{ secrets.SubmoduleToken }}
                    fetch-depth: 0 # Shallow clones should be disabled for a better relevancy of analysis

            -   name: Configure CMake
                run: sudo apt install gcovr && cmake -S $GITHUB_WORKSPACE -B ${{runner.workspace}}/build

            -   name: Generate Coverage Report
                working-directory: ${{runner.workspace}}/build
                run: cmake -DCMAKE_BUILD_TYPE=Debug -S $GITHUB_WORKSPACE -B ${{runner.workspace}}/build && cmake --build . && ./Tests/SettingsStorage_GoogleTestsExe && gcovr --sonarqube > coverage.xml && cat coverage.xml

            -   name: Find coverage.xml
                run: find /home -type f -name coverage.xml

            -   name: Install sonar-scanner and build-wrapper
                uses: sonarsource/sonarcloud-github-c-cpp@v3

            -   name: Run build-wrapper
                run: |
                    mkdir build
                    cmake -S . -B build
                    build-wrapper-linux-x86-64 --out-dir ${{ env.BUILD_WRAPPER_OUT_DIR }} cmake --build build/ --config Release

            -   name: Run sonar-scanner
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                    SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                run: |
                    sonar-scanner --define sonar.cfamily.compile-commands="${{ env.BUILD_WRAPPER_OUT_DIR }}/compile_commands.json"
